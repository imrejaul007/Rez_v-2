import { useState } from 'react';
import { useNavigate, useLocation } from 'react-router-dom';
import {
  ArrowLeft,
  Lock,
  ShoppingBag,
  Truck,
  Store,
  MapPin,
  Clock,
  ChevronRight,
  CreditCard,
  Smartphone,
  Wallet as WalletIcon,
  Shield,
  CheckCircle,
  ChevronDown,
  ChevronUp,
  Minus,
  Plus
} from 'lucide-react';
import { useWallet } from '../contexts/WalletContext';
import Badge from '../components/common/Badge';

const ProductCheckout = () => {
  const navigate = useNavigate();
  const location = useLocation();
  const { rezCoins, promoCoins, brandedCoins, totalCoinsValue } = useWallet();

  // State
  const [deliveryOption, setDeliveryOption] = useState('delivery'); // 'delivery', 'pickup', 'later'
  const [paymentMethod, setPaymentMethod] = useState('upi');
  const [usePromoCoins, setUsePromoCoins] = useState(true);
  const [useBrandedCoins, setUseBrandedCoins] = useState(true);
  const [useRezCoins, setUseRezCoins] = useState(true);
  const [showCoinDetails, setShowCoinDetails] = useState(false);
  const [orderPlaced, setOrderPlaced] = useState(false);

  // Get product data from navigation state or use mock data
  const productFromState = location.state || null;

  const product = productFromState || {
    id: 'sony-headphones',
    name: 'Sony WH-1000XM5 Wireless Headphones',
    brand: 'Tech Galaxy',
    image: 'https://images.unsplash.com/photo-1505740420928-5e560c06d30e?w=200',
    mrp: 29990,
    rezPrice: 24990,
    savings: 5000,
    coinsEarned: 2499,
    cashback: 1200,
    quantity: 1,
    isLocked: false,
    lockAmount: 2499,
    remainingAmount: 22491,
    lockTimeRemaining: '2h 15m',
    deliveryFee: 99,
    deliveryFeeReturnAsCoins: true,
    deliveryTime: '60 mins',
    storePickup: true,
    storeAddress: 'Tech Galaxy, 123 Indiranagar, Bangalore',
    storeDistance: '2.3 km'
  };

  // Normalize the data structure from ProductServicePage
  const productData = {
    id: product.productId || product.id,
    name: product.productName || product.name,
    brand: product.brand,
    image: product.productImage || product.image,
    mrp: product.mrp,
    rezPrice: product.rezPrice,
    savings: product.savings,
    coinsEarned: product.coinsEarnable || product.coinsEarned,
    quantity: product.quantity || 1,
    isLocked: product.isLocked || false,
    lockPrice: product.lockPrice || 0,
    remainingPrice: product.remainingPrice || product.rezPrice,
    timeRemaining: product.timeRemaining,
    purchaseOption: product.purchaseOption || 'direct',
    deliveryFee: product.deliveryFee || 99,
    storeAddress: product.storeAddress || 'Store Address',
    storeDistance: product.storeDistance || 'N/A'
  };

  // Set initial delivery option based on purchase option from product page
  useState(() => {
    if (productData.purchaseOption === 'store') {
      setDeliveryOption('later');
    } else if (productData.purchaseOption === 'delivery') {
      setDeliveryOption('delivery');
    } else if (productData.purchaseOption === 'online') {
      setDeliveryOption('pickup');
    }
  }, []);

  // Calculate coin usage
  const maxCoinsUsable = Math.min(
    totalCoinsValue || 0,
    Math.floor(productData.rezPrice * 0.3) // Max 30% can be paid with coins
  );

  const calculateCoinsToUse = () => {
    let coinsUsed = 0;

    if (usePromoCoins && promoCoins?.balance) {
      const promoUsable = Math.min(
        promoCoins.balance,
        Math.floor(productData.rezPrice * 0.2) // Promo coins max 20%
      );
      coinsUsed += promoUsable;
    }

    if (useBrandedCoins && Array.isArray(brandedCoins)) {
      const brandedTotal = brandedCoins.reduce((sum, coin) => sum + coin.balance, 0);
      const remaining = maxCoinsUsable - coinsUsed;
      coinsUsed += Math.min(brandedTotal, remaining);
    }

    if (useRezCoins && rezCoins?.balance) {
      const remaining = maxCoinsUsable - coinsUsed;
      coinsUsed += Math.min(rezCoins.balance, remaining);
    }

    return Math.min(coinsUsed, maxCoinsUsable);
  };

  const coinsUsed = calculateCoinsToUse();
  const itemTotal = product.isLocked ? product.remainingAmount : product.rezPrice;
  const deliveryCharge = deliveryOption === 'delivery' ? product.deliveryFee : 0;
  const amountPayable = itemTotal - coinsUsed + deliveryCharge;

  const handlePlaceOrder = () => {
    // Handle order placement
    setOrderPlaced(true);
  };

  if (orderPlaced) {
    return (
      <div className="min-h-screen bg-black flex items-center justify-center px-4">
        <div className="max-w-md w-full">
          <div className="text-center mb-8">
            <div className="w-20 h-20 rounded-full bg-emerald-500/20 flex items-center justify-center mx-auto mb-4">
              <CheckCircle className="w-12 h-12 text-emerald-400" />
            </div>
            <h1 className="text-3xl font-bold text-white mb-2">üéâ Order Confirmed!</h1>
            <p className="text-gray-400">Your order has been placed successfully</p>
          </div>

          <div className="p-6 rounded-3xl bg-white/5 border border-white/10 mb-6">
            <div className="flex items-center justify-between mb-4">
              <p className="text-sm text-gray-400">Order ID</p>
              <p className="text-sm font-mono text-white">#RZ{Date.now().toString().slice(-6)}</p>
            </div>
            <div className="flex items-center justify-between mb-4">
              <p className="text-sm text-gray-400">Amount Paid</p>
              <p className="text-lg font-bold text-white">‚Çπ{amountPayable.toLocaleString()}</p>
            </div>
            <div className="flex items-center justify-between p-3 rounded-xl bg-emerald-500/20">
              <p className="text-sm text-emerald-300">Coins Earned</p>
              <p className="text-lg font-bold text-emerald-400">{product.coinsEarned} ü™ô</p>
            </div>
          </div>

          <div className="space-y-3">
            <button className="w-full py-4 rounded-2xl bg-emerald-500 text-white font-bold">
              Track Order
            </button>
            <button className="w-full py-4 rounded-2xl bg-white/5 text-white font-medium">
              Share & Earn Extra Coins
            </button>
            <button
              onClick={() => navigate('/')}
              className="w-full py-4 rounded-2xl bg-white/5 text-white font-medium"
            >
              Back to Home
            </button>
          </div>
        </div>
      </div>
    );
  }

  return (
    <div className="min-h-screen bg-black pb-32">
      {/* üîù TOP BAR */}
      <div className="sticky top-0 z-50 glass">
        <div className="flex items-center justify-between px-4 py-3">
          <button onClick={() => navigate(-1)} className="p-2 rounded-full bg-white/10">
            <ArrowLeft className="w-5 h-5 text-white" />
          </button>
          <div className="flex items-center gap-2">
            <Shield className="w-5 h-5 text-emerald-400" />
            <span className="text-sm font-semibold text-white">Secure Checkout</span>
          </div>
          <div className="flex items-center gap-1 px-3 py-1.5 rounded-full bg-amber-500/20">
            <span className="text-amber-400">ü™ô</span>
            <span className="text-sm font-medium text-amber-400">{totalCoinsValue}</span>
          </div>
        </div>
      </div>

      {/* üõçÔ∏è PRODUCT SUMMARY */}
      <div className="px-4 py-4">
        <div className="p-4 rounded-2xl bg-white/5 border border-white/10 flex items-center gap-4">
          <img
            src={product.image}
            alt={product.name}
            className="w-20 h-20 rounded-xl object-cover"
          />
          <div className="flex-1">
            <p className="text-sm font-semibold text-white mb-1">{product.name}</p>
            <p className="text-xs text-gray-400">{product.brand}</p>
            {product.isLocked && (
              <Badge variant="default" size="sm" className="mt-2 bg-purple-500/20 text-purple-400">
                <Lock className="w-3 h-3 mr-1" />
                Locked ‚Ä¢ {product.lockTimeRemaining} left
              </Badge>
            )}
          </div>
          <div className="text-right">
            <p className="text-lg font-bold text-white">‚Çπ{itemTotal.toLocaleString()}</p>
            <p className="text-xs text-gray-400">Qty: {product.quantity}</p>
          </div>
        </div>
      </div>

      {/* üí∞ PRICE BREAKDOWN */}
      <div className="px-4 mb-6">
        <div className="p-5 rounded-3xl bg-gradient-to-br from-emerald-500/20 to-amber-500/10 border border-emerald-500/30">
          <h3 className="text-base font-bold text-white mb-4">Price Breakdown</h3>

          {product.isLocked && (
            <div className="flex items-center justify-between mb-2 text-sm">
              <span className="text-gray-300">Already Paid (Lock)</span>
              <span className="text-gray-300">‚Çπ{product.lockAmount.toLocaleString()}</span>
            </div>
          )}

          <div className="flex items-center justify-between mb-2 text-sm">
            <span className="text-gray-300">MRP</span>
            <span className="text-gray-400 line-through">‚Çπ{product.mrp.toLocaleString()}</span>
          </div>

          <div className="flex items-center justify-between mb-2 text-sm">
            <span className="text-gray-300">ReZ Price</span>
            <span className="text-white font-semibold">‚Çπ{product.rezPrice.toLocaleString()}</span>
          </div>

          <div className="flex items-center justify-between p-2 rounded-xl bg-emerald-500/20 mb-3">
            <span className="text-sm text-emerald-300 font-semibold">üéâ You Save</span>
            <span className="text-base text-emerald-400 font-bold">‚Çπ{product.savings.toLocaleString()}</span>
          </div>

          <div className="pt-3 border-t border-white/10">
            <p className="text-sm text-gray-300 mb-2">Rewards You'll Earn</p>
            <div className="flex items-center justify-between text-sm mb-1">
              <span className="text-gray-300">ü™ô ReZ Coins</span>
              <span className="text-amber-400 font-semibold">{product.coinsEarned}</span>
            </div>
            <div className="flex items-center justify-between text-sm">
              <span className="text-gray-300">üí∏ Cashback</span>
              <span className="text-emerald-400 font-semibold">‚Çπ{product.cashback}</span>
            </div>
          </div>
        </div>
      </div>

      {/* üöö DELIVERY / PICKUP SELECTION */}
      <div className="px-4 mb-6">
        <h3 className="text-lg font-bold text-white mb-3">Delivery Option</h3>

        <div className="space-y-2">
          {/* 60-Min Delivery */}
          <button
            onClick={() => setDeliveryOption('delivery')}
            className={`w-full p-4 rounded-2xl border flex items-center gap-3 transition-all ${
              deliveryOption === 'delivery'
                ? 'bg-blue-500/20 border-blue-500'
                : 'bg-white/5 border-white/10'
            }`}
          >
            <Truck className="w-5 h-5 text-blue-400" />
            <div className="flex-1 text-left">
              <p className="text-sm font-semibold text-white">60-Minute Home Delivery</p>
              <p className="text-xs text-gray-400">
                Fee: ‚Çπ{product.deliveryFee}
                {product.deliveryFeeReturnAsCoins && ' (returned as coins)'}
              </p>
            </div>
            {deliveryOption === 'delivery' && (
              <CheckCircle className="w-5 h-5 text-blue-400" />
            )}
          </button>

          {/* Store Pickup */}
          {product.storePickup && (
            <button
              onClick={() => setDeliveryOption('pickup')}
              className={`w-full p-4 rounded-2xl border flex items-center gap-3 transition-all ${
                deliveryOption === 'pickup'
                  ? 'bg-emerald-500/20 border-emerald-500'
                  : 'bg-white/5 border-white/10'
              }`}
            >
              <Store className="w-5 h-5 text-emerald-400" />
              <div className="flex-1 text-left">
                <p className="text-sm font-semibold text-white">Store Pickup</p>
                <p className="text-xs text-gray-400">{product.storeAddress} ‚Ä¢ {product.storeDistance}</p>
              </div>
              {deliveryOption === 'pickup' && (
                <CheckCircle className="w-5 h-5 text-emerald-400" />
              )}
            </button>
          )}

          {/* Visit Later (if locked) */}
          {product.isLocked && (
            <button
              onClick={() => setDeliveryOption('later')}
              className={`w-full p-4 rounded-2xl border flex items-center gap-3 transition-all ${
                deliveryOption === 'later'
                  ? 'bg-purple-500/20 border-purple-500'
                  : 'bg-white/5 border-white/10'
              }`}
            >
              <Clock className="w-5 h-5 text-purple-400" />
              <div className="flex-1 text-left">
                <p className="text-sm font-semibold text-white">Visit Store Later</p>
                <p className="text-xs text-gray-400">Pay remaining amount at store</p>
              </div>
              {deliveryOption === 'later' && (
                <CheckCircle className="w-5 h-5 text-purple-400" />
              )}
            </button>
          )}
        </div>
      </div>

      {/* ü™ô APPLY REZ COINS */}
      <div className="px-4 mb-6">
        <div className="p-5 rounded-2xl bg-white/5 border border-white/10">
          <button
            onClick={() => setShowCoinDetails(!showCoinDetails)}
            className="w-full flex items-center justify-between mb-3"
          >
            <div className="flex items-center gap-2">
              <WalletIcon className="w-5 h-5 text-amber-400" />
              <h3 className="text-base font-bold text-white">Apply ReZ Coins</h3>
            </div>
            {showCoinDetails ? (
              <ChevronUp className="w-5 h-5 text-gray-400" />
            ) : (
              <ChevronDown className="w-5 h-5 text-gray-400" />
            )}
          </button>

          <div className="flex items-center justify-between mb-3 p-3 rounded-xl bg-emerald-500/20">
            <span className="text-sm text-white">Coins Applied</span>
            <span className="text-lg font-bold text-emerald-400">‚àí‚Çπ{coinsUsed}</span>
          </div>

          {showCoinDetails && (
            <div className="space-y-3 pt-3 border-t border-white/10">
              {/* Promo Coins */}
              {promoCoins?.balance > 0 && (
                <label className="flex items-center justify-between p-3 rounded-xl bg-white/5 cursor-pointer">
                  <div className="flex items-center gap-3">
                    <input
                      type="checkbox"
                      checked={usePromoCoins}
                      onChange={(e) => setUsePromoCoins(e.target.checked)}
                      className="w-4 h-4"
                    />
                    <div>
                      <p className="text-sm font-medium text-white">Use Promo Coins</p>
                      <p className="text-xs text-gray-400">Max 20% per bill</p>
                    </div>
                  </div>
                  <span className="text-sm text-amber-400">{promoCoins.balance} available</span>
                </label>
              )}

              {/* Branded Coins */}
              {Array.isArray(brandedCoins) && brandedCoins.length > 0 && (
                <label className="flex items-center justify-between p-3 rounded-xl bg-white/5 cursor-pointer">
                  <div className="flex items-center gap-3">
                    <input
                      type="checkbox"
                      checked={useBrandedCoins}
                      onChange={(e) => setUseBrandedCoins(e.target.checked)}
                      className="w-4 h-4"
                    />
                    <div>
                      <p className="text-sm font-medium text-white">Use Branded Coins</p>
                      <p className="text-xs text-gray-400">Merchant specific</p>
                    </div>
                  </div>
                  <span className="text-sm text-purple-400">
                    {brandedCoins.reduce((sum, coin) => sum + coin.balance, 0)} available
                  </span>
                </label>
              )}

              {/* ReZ Coins */}
              {rezCoins?.balance > 0 && (
                <label className="flex items-center justify-between p-3 rounded-xl bg-white/5 cursor-pointer">
                  <div className="flex items-center gap-3">
                    <input
                      type="checkbox"
                      checked={useRezCoins}
                      onChange={(e) => setUseRezCoins(e.target.checked)}
                      className="w-4 h-4"
                    />
                    <div>
                      <p className="text-sm font-medium text-white">Use ReZ Coins</p>
                      <p className="text-xs text-gray-400">Universal coins</p>
                    </div>
                  </div>
                  <span className="text-sm text-emerald-400">{rezCoins.balance} available</span>
                </label>
              )}

              <div className="p-3 rounded-xl bg-blue-500/10 border border-blue-500/20">
                <p className="text-xs text-blue-300">üí° Best savings applied automatically</p>
              </div>
            </div>
          )}
        </div>
      </div>

      {/* üßæ FINAL PAYMENT SUMMARY */}
      <div className="px-4 mb-6">
        <div className="p-5 rounded-2xl bg-white/5 border border-white/10">
          <h3 className="text-base font-bold text-white mb-4">Payment Summary</h3>

          <div className="space-y-2 mb-4">
            <div className="flex items-center justify-between text-sm">
              <span className="text-gray-300">Item Total</span>
              <span className="text-white">‚Çπ{itemTotal.toLocaleString()}</span>
            </div>

            {coinsUsed > 0 && (
              <div className="flex items-center justify-between text-sm">
                <span className="text-gray-300">Coins Used</span>
                <span className="text-emerald-400">‚àí‚Çπ{coinsUsed}</span>
              </div>
            )}

            {deliveryCharge > 0 && (
              <div className="flex items-center justify-between text-sm">
                <span className="text-gray-300">Delivery Fee</span>
                <span className="text-white">‚Çπ{deliveryCharge}</span>
              </div>
            )}
          </div>

          <div className="pt-4 border-t border-white/10 flex items-center justify-between">
            <span className="text-base font-semibold text-white">Amount Payable</span>
            <span className="text-2xl font-bold text-white">‚Çπ{amountPayable.toLocaleString()}</span>
          </div>
        </div>
      </div>

      {/* üîê PAYMENT METHOD */}
      <div className="px-4 mb-6">
        <h3 className="text-lg font-bold text-white mb-3">Payment Method</h3>

        <div className="space-y-2">
          <label className="flex items-center gap-3 p-4 rounded-2xl bg-white/5 border border-white/10 cursor-pointer">
            <input
              type="radio"
              name="payment"
              value="upi"
              checked={paymentMethod === 'upi'}
              onChange={(e) => setPaymentMethod(e.target.value)}
              className="w-4 h-4"
            />
            <Smartphone className="w-5 h-5 text-blue-400" />
            <span className="text-sm font-medium text-white">UPI</span>
          </label>

          <label className="flex items-center gap-3 p-4 rounded-2xl bg-white/5 border border-white/10 cursor-pointer">
            <input
              type="radio"
              name="payment"
              value="card"
              checked={paymentMethod === 'card'}
              onChange={(e) => setPaymentMethod(e.target.value)}
              className="w-4 h-4"
            />
            <CreditCard className="w-5 h-5 text-purple-400" />
            <span className="text-sm font-medium text-white">Card</span>
          </label>

          <label className="flex items-center gap-3 p-4 rounded-2xl bg-white/5 border border-white/10 cursor-pointer">
            <input
              type="radio"
              name="payment"
              value="wallet"
              checked={paymentMethod === 'wallet'}
              onChange={(e) => setPaymentMethod(e.target.value)}
              className="w-4 h-4"
            />
            <WalletIcon className="w-5 h-5 text-emerald-400" />
            <span className="text-sm font-medium text-white">Wallet</span>
          </label>
        </div>

        <div className="mt-3 p-3 rounded-xl bg-green-500/10 border border-green-500/20 flex items-center gap-2">
          <Shield className="w-4 h-4 text-green-400" />
          <p className="text-xs text-green-300">üîí 100% secure payment</p>
        </div>
      </div>

      {/* üîò STICKY BOTTOM BAR */}
      <div className="fixed bottom-0 left-0 right-0 z-50 glass border-t border-white/10 p-4">
        <button
          onClick={handlePlaceOrder}
          className="w-full py-4 rounded-2xl bg-emerald-500 text-white font-bold flex items-center justify-center gap-2 active:scale-95 transition-transform"
        >
          <Shield className="w-5 h-5" />
          {product.isLocked ? `Pay ‚Çπ${amountPayable.toLocaleString()} & Complete Purchase` : `Pay ‚Çπ${amountPayable.toLocaleString()} & Place Order`}
        </button>
      </div>
    </div>
  );
};

export default ProductCheckout;
